@{
    var _orders = (Greenspot.Stall.Models.ViewModels.OrderCollectionViewModel)ViewBag.Orders;
    var _orderJson = Newtonsoft.Json.JsonConvert.SerializeObject(_orders);
    var _isAdmin = User.IsInRole("Admin");
}
<!DOCTYPE html>
<html lang="en" ng-app="greenspotStall" ng-cloak>
<head>
    <meta charset="utf-8">
    <meta name="description" content="Stall@Greenspot">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <base href="/">
    <title>确认订单</title>
    <link rel="shortcut icon" href="/static/img/favicon.png">
    <!-- 3rd party stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/angular-material/1.1.0-rc4/angular-material.min.css">
    <!-- platform stylesheet -->
    @if (HttpContext.Current.IsDebuggingEnabled)
    {
        <link rel="stylesheet/less" href="/Content/less/global.less">
        <link rel="stylesheet/less" href="/Content/less/customer.less">
    }
    else
    {
        <link rel="stylesheet" href="/Static/css/stall.min.css">
    }
</head>
<body ng-controller="CustomerController as custCtrl" ng-init="custCtrl.init_checkout(@_orderJson)">
    <!-- address -->
    <md-content id="checkout-content">
        <div class="checkout-section">
            <div class="caption">配送地址 <a href="/customer/addresses" md-colors="{color: 'accent'}">添加</a></div>
            <md-radio-group ng-model="custCtrl.selectedDeliveryAddress" ng-change="custCtrl.deliveryAddressChanged()">
                <div ng-repeat='addr in custCtrl.deliveryAddresses' class="row">
                    <md-radio-button flex ng-value="addr" class="md-primary delivery-address">
                        <span class="delivery-address-name">{{addr.Name}}, {{addr.Mobile}}</span>
                        {{addr.FullAddress}}
                    </md-radio-button>
                </div>
            </md-radio-group>
        </div>

        <!-- stalls -->
        <div class="checkout-section" checkout-stall" ng-repeat="order in custCtrl.orders">
            <!-- name -->
            <div class="caption">
                {{order.n}}
            </div>

            <!-- delivery -->
            <div class="checkout-section" ng-if="!order.hasDeliveryOption() && !order.hasPickUpOption()">
                <div class="caption">该店铺没有适合的配送计划</div>
            </div>
            <div layout="row" layout-align="space-between center" ng-if="order.hasDeliveryOption() || order.hasPickUpOption()">
                <div>
                    <span ng-if="order.hasDeliveryOption() && !order.hasPickUpOption()">配送</span>
                    <span ng-if="!order.hasDeliveryOption() && order.hasPickUpOption()">自提</span>
                    <div class="switcher" ng-if="order.hasDeliveryOption() && order.hasPickUpOption()">
                        <div class="switcher-item" ng-class="{'switch-on': !order.isPickup}" ng-click="order.setIsPickup(false)">配送</div>
                        <div class="switcher-item" ng-class="{'switch-on': order.isPickup}" ng-click="order.setIsPickup(true)">自提</div>
                    </div>
                </div>
                <div>
                    <!--date-->
                    <select ng-options="(collection.Date|date:'EEE dMMM') for collection in order.optionCollections"
                            ng-model="order.selectedOptionCollection" ng-change="order.optionCollectionChanged()"></select>
                    <!--time-->
                    <select ng-options="((opt.From|date:'HH:mm')+'-'+(opt.To|date:'HH:mm')+' '+(opt.Fee|currency:$)) for opt in order.selectedOptionCollection.ApplicableOpts"
                            ng-model="order.selectedOption" ng-change="order.optionChanged()"></select>
                </div>
            </div>

            <!-- pickup address -->
            <div class="checkout-item" layout="row" layout-align="space-between center" ng-if="order.isPickup">
                <div class="item-name">自提地址</div>
                <div class="item-price-qty">
                    {{order.selectedOption.PickUpAddress}}
                </div>
            </div>

            <!-- items -->
            <div class="checkout-item" ng-repeat="item in order.itms track by item.i" layout="row" layout-align="space-between center">
                <div class="item-name">{{item.n}}</div>
                <div class="item-price-qty">
                    {{item.p|currency:$}} x{{item.q}}
                </div>
            </div>
            <!-- delivery -->
            <div class="checkout-item" ng-if="order.selectedOption" layout="row" layout-align="space-between center">
                <div class="item-name">运费</div>
                <div class="item-price-qty">
                    {{order.selectedOption.Fee|currency:$}}
                </div>
            </div>
            <!-- total -->
            <div class="checkout-item" layout="row" layout-align="space-between center">
                <div class="item-name">合计</div>
                <div class="item-price-qty">
                    {{order.totalAmount()|currency:$}}
                </div>
            </div>
            <!-- note -->
            <div class="checkout-item" layout="row" layout-align="space-between center">
                <div class="item-name" flex="10">留言</div>
                <input type="text" ng-model="order.note" flex/>
            </div>
        </div>

        <!-- operation -->
        <div class="checkout-operate" layout="row">
            <md-button flex="100" ng-click="custCtrl.pay()" class="md-raised md-primary"
                       ng-disabled="!custCtrl.allDeliverySelected()">
                确认付款
            </md-button>
            @if (_isAdmin)
            {
                <a ng-click="custCtrl.fakePay()">Success</a>
                    <a href="">Pay Fail</a>
            }
        </div>
    </md-content>
    <!-- 3rd party libraries -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular-route.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular-aria.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular-animate.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular-messages.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular-material/1.1.0-rc4/angular-material.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.2/js.cookie.min.js"></script>
    <!-- owner scripts -->
    @if (HttpContext.Current.IsDebuggingEnabled)
    {
        <script type="text/javascript" src="/Static/lib/less/dist/less.min.js"></script>
            <script type="text/javascript" src="/Content/middle-js/app.js"></script>
            <script type="text/javascript" src="~/Content/middle-js/cart.js"></script>
            <script type="text/javascript" src="~/Content/middle-js/order.js"></script>
            <script type="text/javascript" src="/Content/middle-js/controller/customer.controller.js"></script>
    }
    else
    {
        <script type="text/javascript" src="/Static/js/stall.min.js"></script>
    }
</body>

</html>
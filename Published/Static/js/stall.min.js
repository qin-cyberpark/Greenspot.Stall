!function(){"use strict";angular.module("greenspotStall",["ngMaterial","ngMessages"]).config(["$locationProvider","$mdThemingProvider","$mdIconProvider",function(e,t,o){t.theme("default").primaryPalette("teal").accentPalette("lime"),o.defaultIconSet("/static/img/icon/core-icons.svg",24)}])}(),function(){"use strict";function e(e,t){var o=this;o.i=e,o.n=t,o.qty=0,o.amt=0,o.itms=[],o.add=function(e){o.qty++,o.amt+=e.price;var t=!1;$.each(o.itms,function(o,r){return r.i==e.id?(r.q++,t=!0,!1):void 0}),t||o.itms.push({i:e.id,n:e.name,v:e.variant,q:1,p:e.price})},o.remove=function(e){var t=0;return $.each(o.itms,function(r,s){if(s.i==e){var n=o.itms.indexOf(s);return n>-1&&o.itms.splice(n,1),t=s.q,o.qty-=s.q,o.amt-=s.p*s.q,!1}}),t},o.plusOne=function(e){$.each(o.itms,function(t,r){r.i==e&&r.q<99&&(r.q++,o.qty++,o.amt+=r.p)})},o.minusOne=function(e){$.each(o.itms,function(t,r){r.i==e&&r.q>0&&(r.q--,o.qty--,o.amt-=r.p)})}}var t=angular.module("greenspotStall");t.controller("CustomerController",["$scope","$http","$location","$window","$mdDialog",function(t,o,r,s,n){var i=this;i.gotoUrl=function(e){window.location.href=e},i.init=function(){i.cart.loadFromCookie()},i.cart={stls:[],qty:0,selectStall:function(e){i.order.stall=e},add:function(t){this.qty++;var o=!1;if($.each(this.stls,function(e,r){return r.i==t.stallId?(o=!0,r.add(t),!1):void 0}),!o){var r=new e(t.stallId,t.stallName);r.add(t),this.stls.push(r)}this.writeToCookie()},empty:function(){this.stls=[],this.qty=0,Cookies.remove("cart")},remove:function(e,t){if(this.qty-=e.remove(t),0==e.itms.length){var o=this.stls.indexOf(e);o>-1&&this.stls.splice(o,1)}this.writeToCookie()},plusOne:function(e,t){e.plusOne(t),this.qty++,this.writeToCookie()},minusOne:function(e,t){e.minusOne(t),this.qty--,this.writeToCookie()},loadFromCookie:function(){var t=Cookies.get("cart");if(t){var o=$.parseJSON(t);this.stls=[],$.each(o.stls,function(t,o){var r=new e(o.i,o.n);r.qty=o.qty,r.amt=o.amt,r.itms=o.itms,i.cart.stls.push(r)}),this.qty=o.qty,i.order.stall=i.cart.stls[0]}},writeToCookie:function(){Cookies.set("cart",this,{expires:14})}},i.checkOut=function(){o.post("/customer/CheckStock",i.order).success(function(e){e.Succeeded?window.location.href="/customer/Checkout":console.log(e.Message)}).error(function(e){console.log(e)})},i.init_checkout=function(e){i.order=e,i.loadDeliveryAddress(i.loadDeliverySchedule)},i.init_address=function(){i.loadDeliveryAddress()},i.order={},i.loadDeliveryAddress=function(e){o.get("/customer/DeliveryAddresses").success(function(t){t.Succeeded?(i.deliveryAddresses=t.Data,i.order.deliveryAddress=i.deliveryAddresses[0],e&&e()):console.log(t.Message)}).error(function(e){console.log(e)})},i.loadDeliverySchedule=function(){var e="/api/stall/DeliverySchedule/"+i.order.stall.i+"?country="+i.order.deliveryAddress.CountryId;e+="&city="+i.order.deliveryAddress.City,e+="&area="+i.order.deliveryAddress.Area,o.get(e).success(function(e){e.Succeeded?(i.deliverySchedule=e.Data,i.order.deliveryOption=i.deliverySchedule[0],i.SelectDeliveryOption()):(s.alert(e.Message),console.log(e.Message))}).error(function(e){console.log(e)})},i.getDeliveryFee=function(){if(i.order.deliveryFee=null,!i.order.deliveryOption)return void alert("无法获取配送信息");if(i.order.deliveryOption.IsPickUp)i.order.deliveryFee=0,i.order.amount=i.order.stall.amt+i.order.deliveryFee;else{var e="/api/stall/CalcDeliveryFee/"+i.order.stall.i+"?country="+i.order.deliveryAddress.CountryId;e+="&city="+i.order.deliveryAddress.City,e+="&suburb="+i.order.deliveryAddress.Suburb,e+="&amount="+i.order.stall.amt,o.get(e).success(function(e){e.Succeeded?(i.order.deliveryFee=e.Data,i.order.amount=i.order.stall.amt+i.order.deliveryFee):(s.alert(e.Message),console.log(e.Message))}).error(function(e){console.log(e)})}},i.SelectDeliveryAddress=function(){i.loadDeliverySchedule()},i.SelectDeliveryOption=function(){i.getDeliveryFee()},i.editAddress={},i.addressSelected=function(){t.$apply(function(){i.editAddress.Address=i.editAddress.AddressObject.FullAddress})},i.selectArea=function(e){n.show({controller:"DialogController",controllerAs:"ctrl",templateUrl:"/SelectArea.tmpl.html",parent:angular.element(document.body),targetEvent:e}).then(function(e){console.log(e),i.editAddress.Area=e.en,i.editAddress.SelectedAreaName=e.cn})},i.addAddress=function(e){if(!i.editAddress.AddressObject)return alert("请选择地址"),!1;if(i.editAddress.Area)i.submitAddress();else{var t="/api/address/Suburb2Area?country=NZ&city="+i.editAddress.AddressObject.CityTown;t+="&suburb="+i.editAddress.AddressObject.Suburb,o.get(t).success(function(t){t.Succeeded?(i.editAddress.Area=t.Data,i.submitAddress()):i.selectArea(e)}).error(function(t){i.selectArea(e)})}},i.submitAddress=function(){console.log(i.editAddress),o.post("/customer/addAddress",i.editAddress).success(function(e){e.Succeeded?(i.loadDeliveryAddress(),i.gotoUrl("/customer/checkout")):alert(e.Message)}).error(function(e){alert(e)})},i.pay=function(){console.log(i.order),o.post("/customer/Pay",i.order).success(function(e){e.Succeeded?(console.log(e),window.location.href=e.Data):console.log(e.Message)}).error(function(e){console.log(e)})},i.fakePay=function(){console.log(i.order),o.post("/customer/fakePay",i.order).success(function(e){e.Succeeded?(console.log(e),window.location.href=e.Data):console.log(e.Message)}).error(function(e){console.log(e)})}}]),t.controller("DialogController",["$scope","$mdDialog",function(e,t){e.hide=function(){t.hide()},e.cancel=function(){t.cancel()},e.answer=function(e){t.hide(e)}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("OwnerController",["$http","$location",function(e,t){var o=this;o.gotoUrl=function(e){window.location.href=e},o.Register=function(){e.post("/owner/Register",this.OwnerInfo).success(function(e){e.Succeeded?window.location.href=e.Data:console.log(e.Message)}).error(function(e){console.log(e)})}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.directive("googleplace",function(){return{scope:{addrObj:"=addressObject",placeOnSelect:"&"},link:function(e,t,o,r){var s={types:["address"],componentRestrictions:{country:"nz"}};e.googlePlaceAutocomplete=new google.maps.places.Autocomplete(t[0],s),google.maps.event.addListener(e.googlePlaceAutocomplete,"place_changed",function(){e.$apply(function(){e.addrObj=e.googlePlaceAutocomplete.getPlace()}),e.placeOnSelect()})}}})}(),function(){"use strict";var e=angular.module("greenspotStall");e.directive("addressChecker",function(){return{scope:{addrObj:"=addressObject",placeOnSelect:"&"},link:function(e,t,o,r){var s={max_results:3,search_type:"Physical",populates:{suburb:"Suburb",city:"CityTown",postcode:"Postcode"},theme:{boxClass:"AddrAutoCompleteBox"},success:function(t){e.$apply(function(){e.addrObj=t}),e.placeOnSelect()}};e.addressChecker=new NZPost.Addressing.Checker(t[0],"af322550-a9de-0132-86ce-00505692031f",s)}}})}();
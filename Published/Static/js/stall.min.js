!function(){"use strict";angular.module("greenspotStall",["ngMaterial","ngMessages"]).config(["$locationProvider","$mdThemingProvider","$mdIconProvider",function(e,t,o){t.theme("default").primaryPalette("cyan",{"default":"700"}).accentPalette("orange",{"default":"A200"}).backgroundPalette("cyan",{"default":"50"}),o.defaultIconSet("/static/img/icon/core-icons.svg",24)}])}(),function(){"use strict";function e(e,t){var o=this;o.i=e,o.n=t,o.qty=0,o.amt=0,o.itms=[],o.add=function(e){o.qty++,o.amt+=e.price;var t=!1;$.each(o.itms,function(o,s){return s.i==e.id?(s.q++,t=!0,!1):void 0}),t||o.itms.push({i:e.id,n:e.name,v:e.variant,q:1,p:e.price})},o.remove=function(e){var t=0;return $.each(o.itms,function(s,i){if(i.i==e){var r=o.itms.indexOf(i);return r>-1&&o.itms.splice(r,1),t=i.q,o.qty-=i.q,o.amt-=i.p*i.q,!1}}),t},o.plusOne=function(e){$.each(o.itms,function(t,s){s.i==e&&s.q<99&&(s.q++,o.qty++,o.amt+=s.p)})},o.minusOne=function(e){$.each(o.itms,function(t,s){s.i==e&&s.q>0&&(s.q--,o.qty--,o.amt-=s.p)})}}var t=angular.module("greenspotStall");t.controller("CustomerController",["$scope","$http","$location","$window","$mdDialog",function(t,o,s,i,r){var n=this;n.gotoUrl=function(e){window.location.href=e},n.init=function(){n.cart.loadFromCookie()},n.removeStallCookie=function(e){n.cart.loadFromCookie(),n.cart.removeStall(e)},n.cart={stls:[],qty:0,selectStall:function(e){n.order.stall=e},removeStall:function(e){for(var t=0;t<this.stls.length;t++)if(this.stls[t].i==e){this.qty-=this.stls[t].qty,this.stls.splice(t,1);break}this.writeToCookie()},add:function(t){this.qty++;var o=!1;if($.each(this.stls,function(e,s){return s.i==t.stallId?(o=!0,s.add(t),!1):void 0}),!o){var s=new e(t.stallId,t.stallName);s.add(t),this.stls.push(s)}this.writeToCookie()},empty:function(){this.stls=[],this.qty=0,Cookies.remove("cart")},remove:function(e,t){if(this.qty-=e.remove(t),0==e.itms.length){var o=this.stls.indexOf(e);o>-1&&this.stls.splice(o,1)}this.writeToCookie()},plusOne:function(e,t){e.plusOne(t),this.qty++,this.writeToCookie()},minusOne:function(e,t){e.minusOne(t),this.qty--,this.writeToCookie()},loadFromCookie:function(){var t=Cookies.get("cart");if(t){var o=$.parseJSON(t);this.stls=[],$.each(o.stls,function(t,o){var s=new e(o.i,o.n);s.qty=o.qty,s.amt=o.amt,s.itms=o.itms,n.cart.stls.push(s)}),this.qty=o.qty,n.order.stall=n.cart.stls[0]}},writeToCookie:function(){Cookies.set("cart",this,{expires:14})}},n.checkOut=function(){o.post("/customer/CheckStock",n.order).success(function(e){e.Succeeded?window.location.href="/customer/Checkout":console.log(e.Message)}).error(function(e){console.log(e)})},n.init_checkout=function(e){n.order=e,n.loadDeliveryAddress(n.loadDeliveryOptions),n.loadPickUpOptions()},n.order={},n.loadDeliveryAddress=function(e){o.get("/customer/DeliveryAddresses").success(function(t){t.Succeeded?(n.deliveryAddresses=t.Data,n.deliveryAddresses.length>0&&(n.order.deliveryAddress=n.deliveryAddresses[0]),e&&e()):console.log(t.Message)}).error(function(e){console.log(e)})},n.loadDeliveryOptions=function(){n.deliveryOptions=[],n.order.deliveryOption=null;var e="/api/stall/GetDeliveryOptions/"+n.order.stall.i+"?country="+n.order.deliveryAddress.CountryId;e+="&city="+n.order.deliveryAddress.City,e+="&suburb="+n.order.deliveryAddress.Suburb,e+="&area="+n.order.deliveryAddress.Area,o.get(e).success(function(e){e.Succeeded?(n.deliveryOptionCollections=e.Data,n.deliveryOptionCollections.length>0&&(n.selectedDeliveryOptionCollection=n.deliveryOptionCollections[0],n.selectDeliveryDate())):(i.alert(e.Message),console.log(e.Message))}).error(function(e){console.log(e)})},n.loadPickUpOptions=function(){console.log(n.order.deliveryAddress),n.pickUpOptions=[],n.order.deliveryOption=null;var e="/api/stall/GetPickUpOptions/"+n.order.stall.i;o.get(e).success(function(e){e.Succeeded?(n.pickUpOptionCollections=e.Data,n.deliveryOptionCollections&&n.deliveryOptionCollections.length>0&&(n.selectedDeliveryOptionCollection=n.pickUpOptionCollections[0],n.selectDeliveryDate())):(i.alert(e.Message),console.log(e.Message))}).error(function(e){console.log(e)})},n.selectDeliveryAddress=function(){n.order.deliveryOption=null,"pickup"!=n.order.deliveryAddress?(n.order.isPickUp=!1,n.loadDeliveryOptions()):(n.order.isPickUp=!0,n.pickUpOptionCollections&&n.pickUpOptionCollections.length>0&&(n.selectedDeliveryOptionCollection=n.pickUpOptionCollections[0],n.selectDeliveryDate()))},n.selectDeliveryDate=function(){n.order.deliveryOption=null,(n.selectedDeliveryOptionCollection.ApplicableOpts||n.selectedDeliveryOptionCollection.ApplicableOpts.length>0)&&(n.order.deliveryOption=n.selectedDeliveryOptionCollection.ApplicableOpts[0],n.selectDeliveryOption())},n.selectDeliveryOption=function(){console.log(n.order.deliveryOption),n.order.amount=n.order.stall.amt+n.order.deliveryOption.Fee},n.init_address=function(){n.loadDeliveryAddress()},n.editAddress={},n.addressSelected=function(){t.$apply(function(){n.editAddress.Address=n.editAddress.AddressObject.FullAddress})},n.selectArea=function(e){r.show({controller:"DialogController",controllerAs:"ctrl",templateUrl:"/SelectArea.tmpl.html",parent:angular.element(document.body),targetEvent:e}).then(function(e){console.log(e),n.editAddress.Area=e.en,n.editAddress.SelectedAreaName=e.cn})},n.addAddress=function(e){if(!n.editAddress.AddressObject)return alert("请选择地址"),!1;if(n.editAddress.Area)n.submitAddress();else{var t="/api/address/Suburb2Area?country=NZ&city="+n.editAddress.AddressObject.CityTown;t+="&suburb="+n.editAddress.AddressObject.Suburb,o.get(t).success(function(t){t.Succeeded?(n.editAddress.Area=t.Data,n.submitAddress()):n.selectArea(e)}).error(function(t){n.selectArea(e)})}},n.submitAddress=function(){console.log(n.editAddress),o.post("/customer/addAddress",n.editAddress).success(function(e){e.Succeeded?(n.loadDeliveryAddress(),n.gotoUrl("/customer/checkout")):alert(e.Message)}).error(function(e){alert(e)})},n.pay=function(){console.log(n.order),"pickup"==n.order.deliveryAddress&&(n.order.deliveryAddress=null),o.post("/customer/Pay",n.order).success(function(e){e.Succeeded?(console.log(e),window.location.href=e.Data):console.log(e.Message)}).error(function(e){console.log(e)})},n.fakePay=function(){console.log(n.order),o.post("/customer/fakePay",n.order).success(function(e){e.Succeeded?(console.log(e),window.location.href=e.Data):console.log(e.Message)}).error(function(e){console.log(e)})}}]),t.controller("DialogController",["$scope","$mdDialog",function(e,t){e.hide=function(){t.hide()},e.cancel=function(){t.cancel()},e.answer=function(e){t.hide(e)}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("OwnerController",["$http","$location",function(e,t){var o=this;o.gotoUrl=function(e){window.location.href=e},o.Register=function(){e.post("/owner/Register",this.OwnerInfo).success(function(e){e.Succeeded?window.location.href=e.Data:console.log(e.Message)}).error(function(e){console.log(e)})}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.directive("googleplace",function(){return{scope:{addrObj:"=addressObject",placeOnSelect:"&"},link:function(e,t,o,s){var i={types:["address"],componentRestrictions:{country:"nz"}};e.googlePlaceAutocomplete=new google.maps.places.Autocomplete(t[0],i),google.maps.event.addListener(e.googlePlaceAutocomplete,"place_changed",function(){e.$apply(function(){e.addrObj=e.googlePlaceAutocomplete.getPlace()}),e.placeOnSelect()})}}})}(),function(){"use strict";var e=angular.module("greenspotStall");e.directive("addressChecker",function(){return{scope:{addrObj:"=addressObject",placeOnSelect:"&"},link:function(e,t,o,s){var i={max_results:3,search_type:"Physical",populates:{suburb:"Suburb",city:"CityTown",postcode:"Postcode"},theme:{boxClass:"AddrAutoCompleteBox"},success:function(t){e.$apply(function(){e.addrObj=t}),e.placeOnSelect()}};e.addressChecker=new NZPost.Addressing.Checker(t[0],"af322550-a9de-0132-86ce-00505692031f",i)}}})}();
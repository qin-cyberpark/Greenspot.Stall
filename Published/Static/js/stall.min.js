var Greenspot=Greenspot||{};!function(){Greenspot.Utilities=Greenspot.Utilities||{},Greenspot.Utilities.SearchResult=function(e,t){var o=this;o.page=e||0,o.pageSize=t||10,o.items=[],o.hasMore=!1,o.hasRecord=!1,o.append=function(e){e&&e.length&&(o.items=o.items.concat(e)),o.hasMore=e&&e.length==o.pageSize,o.hasRecord=o.items.length}},Greenspot.Utilities.SearchResult.Parse=function(e){var t=JSON.parse(e),o=new Greenspot.Utilities.SearchResult(t.page,t.pageSize);return o.items=t.items,o.hasMore=t.hasMore,o.hasRecord=t.hasRecord,o}}(),function(){"use strict";angular.module("greenspotStall",["ngMaterial","ngMessages"]).config(["$locationProvider","$mdThemingProvider","$mdIconProvider",function(e,t,o){t.theme("default").primaryPalette("cyan",{default:"700"}).accentPalette("orange",{default:"800"}).backgroundPalette("grey",{default:"100"}),o.defaultIconSet("/static/img/icon/core-icons.svg",24),e.html5Mode(!0)}]).service("CommonService",["$rootScope",function(e){var t=this;e.gotoUrl=function(e){t.showLoading(),window.location.href=e},e.loadingCircle=!1,t.showLoading=function(){e.loadingCircle=!0},t.hideLoading=function(){e.loadingCircle=!1},t.isLoading=function(){return e.loadingCircle}}]).filter("trust",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}])}();var Greenspot=Greenspot||{};!function(){Greenspot.CartStallItem=function(e,t){var o=this;o.i=e,o.n=t,o.qty=0,o.itms=[],o.add=function(e,t){t=t?t:1,o.qty+=t;var n=!1;angular.forEach(o.itms,function(o,r){if(o.i==e.id)return o.q+=t,n=!0,!1}),n||o.itms.push({i:e.id,n:e.name,v:e.variant,q:t,p:e.price,slctd:!0})},o.remove=function(e){var t=0;return angular.forEach(o.itms,function(n,r){if(n.i==e){var s=o.itms.indexOf(n);return s>-1&&o.itms.splice(s,1),t=n.q,o.qty-=n.q,!1}}),t},o.isChecked=function(){var e=!1,t=!1;return angular.forEach(o.itms,function(o,n){e=e||o.slctd,t=t||!o.slctd}),e&&!t},o.isIndeterminate=function(){var e=!1,t=!1;return angular.forEach(o.itms,function(o,n){e=e||o.slctd,t=t||!o.slctd}),e&&t},o.toggle=function(e){e.slctd=!e.slctd},o.toggleAll=function(){var e=o.isIndeterminate()||!o.isChecked();angular.forEach(o.itms,function(t,o){t.slctd=e})},o.plusOne=function(e){angular.forEach(o.itms,function(t,n){t.i==e&&t.q<99&&(t.q++,o.qty++)})},o.minusOne=function(e){angular.forEach(o.itms,function(t,n){t.i==e&&t.q>0&&(t.q--,o.qty--)})}},Greenspot.Cart=function(){var e=this;e.stls=[],e.qty=0,e.removeStall=function(t){for(var o=0;o<e.stls.length;o++)if(e.stls[o].i==t){e.qty-=e.stls[o].qty,e.stls.splice(o,1);break}e.save()},e.add=function(t,o){o=o?parseInt(o):1,e.qty+=o;var n=!1;if(angular.forEach(e.stls,function(e,r){if(e.i==t.stallId)return n=!0,e.add(t,o),!1}),!n){var r=new Greenspot.CartStallItem(t.stallId,t.stallName);r.add(t,o),e.stls.push(r)}e.save()},e.remove=function(t,o){if(e.qty-=t.remove(o),0==t.itms.length){var n=e.stls.indexOf(t);n>-1&&e.stls.splice(n,1)}e.save()},e.empty=function(){e.stls=[],e.qty=0,Cookies.remove("cart")},e.plusOne=function(t,o){t.plusOne(o),e.qty++,e.save()},e.minusOne=function(t,o){t.minusOne(o),e.qty--,e.save()},e.load=function(){var t=window.localStorage.jdl_cart;if(t){var o=angular.fromJson(t),n=Date.now()-o.savedTime;n>6048e5||(e.stls=[],angular.forEach(o.stls,function(t,o){var n=new Greenspot.CartStallItem(t.i,t.n);n.qty=t.qty,n.amt=t.amt,n.itms=t.itms,e.stls.push(n)}),e.qty=o.qty)}},e.save=function(){e.savedTime=Date.now(),window.localStorage.setItem("jdl_cart",JSON.stringify(e))},e.isChecked=function(){var t=!1,o=!1;return angular.forEach(e.stls,function(e,n){t=t||e.isChecked(),o=o||!e.isChecked()}),t&&!o},e.toggleAll=function(){var t=!e.isChecked();angular.forEach(e.stls,function(e,o){angular.forEach(e.itms,function(e,o){e.slctd=t})})},e.totalAmount=function(t){t=t||!1;var o=0;return angular.forEach(e.stls,function(e,n){angular.forEach(e.itms,function(e,n){t&&!e.slctd||(o+=e.p*e.q)})}),o},e.getOrders=function(){var t=new Greenspot.CartOrderCollection;return angular.forEach(e.stls,function(e,o){var n=new Greenspot.CartOrder(e.i,e.n);angular.forEach(e.itms,function(e,t){e.slctd&&n.AddItem(e)}),n.qty>0&&t.AddOrder(n)}),t},e.removeSelected=function(){console.log("remove");new Greenspot.CartOrderCollection;angular.forEach(e.stls,function(t,o){t.isChecked()?e.removeStall(t.i):angular.forEach(t.itms,function(o,n){o&&o.slctd&&e.remove(t,o.i)})}),e.save()}},Greenspot.CartOrder=function(e,t){var o=this;o.i=e,o.n=t,o.qty=0,o.amt=0,o.itms=[],o.AddItem=function(e){o.itms.push(e),o.qty+=e.q,o.amt+=e.p*e.q}},Greenspot.CartOrderCollection=function(){var e=this;e.orders=[],e.amt=0,e.qty=0,e.AddOrder=function(t){e.orders.push(t),e.qty+=t.qty,e.amt+=t.amt}}}();var Greenspot=Greenspot||{};!function(){Greenspot.Order=function(e,t){var o=this;o.$http=t,o.i=e.i,o.n=e.n,o.qty=e.qty,o.amt=e.amt,o.itms=e.itms,o.deliveryOptionCollections=[],o.pickUpOptionCollections=[],o.optionCollections=[],o.selectedOptionCollection=null,o.selectedOption=null,o.setDeliveryAddress=function(e){o.deliveryAddress=e,o.optionCollections=[],o.selectedOptionCollection=null,o.selectedOption=null,o.loadDeliveryOptions()},o.loadDeliveryOptions=function(){if(o.deliveryOptionCollections=[],o.deliveryAddress){var e="/api/stall/"+o.i+"/GetDeliveryOptions?area="+o.deliveryAddress.Area;e+="&orderAmount="+o.amt,o.$http.get(e).success(function(e){e.Succeeded?(o.deliveryOptionCollections=e.Data,o.hasDeliveryOption()?o.setIsPickup(!1):o.hasPickUpOption()&&o.setIsPickup(!0)):console.log(e.Message)}).error(function(e){console.log(e)})}},o.loadPickUpOptions=function(){o.pickUpOptionCollections=[];var e="/api/stall/"+o.i+"/GetPickUpOptions";t.get(e).success(function(e){e.Succeeded?(o.pickUpOptionCollections=e.Data,o.hasPickUpOption()&&o.setIsPickup(!0)):console.log(e.Message)}).error(function(e){console.log(e)})},o.hasDeliveryOption=function(){return o.deliveryOptionCollections&&o.deliveryOptionCollections.length>0},o.hasPickUpOption=function(){return o.pickUpOptionCollections&&o.pickUpOptionCollections.length>0},o.optionCollectionChanged=function(){o.selectedOption=o.selectedOptionCollection.ApplicableOpts[0]},o.optionChanged=function(){},o.totalAmount=function(){return o.amt+(o.selectedOption?o.selectedOption.Fee:0)},o.setIsPickup=function(e){o.isPickup=e,o.optionCollections=e?o.pickUpOptionCollections:o.deliveryOptionCollections,o.selectedOptionCollection=o.optionCollections[0],o.optionCollectionChanged()},o.loadPickUpOptions()}}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("CustomerAddressController",["$scope","$http","$location","$window","$mdDialog",function(e,t,o,n,r){var s=this;s.gotoUrl=function(e){window.location.href=e},s.init_address=function(){s.loadDeliveryAddress()},s.editAddress={},s.loadDeliveryAddress=function(){t.get("/customer/DeliveryAddresses").success(function(e){e.Succeeded?(s.deliveryAddresses=e.Data,s.deliveryAddresses.length>0&&(s.deliveryAddress=s.deliveryAddresses[0])):console.log(e.Message)}).error(function(e){console.log(e)})},s.addressSelected=function(){e.$apply(function(){s.editAddress.Address=s.editAddress.AddressObject.FullAddress})},s.selectArea=function(e){r.show({controller:"DialogController",controllerAs:"ctrl",templateUrl:"/SelectArea.tmpl.html",parent:angular.element(document.body),targetEvent:e}).then(function(e){console.log(e),s.editAddress.Area=e.en,s.editAddress.SelectedAreaName=e.cn})},s.addAddress=function(e){if(!s.editAddress.AddressObject)return alert("请选择地址"),!1;if(s.editAddress.Area)s.submitAddress();else{var o="/api/address/Suburb2Area?country=NZ&city="+s.editAddress.AddressObject.CityTown;o+="&suburb="+s.editAddress.AddressObject.Suburb,t.get(o).success(function(t){t.Succeeded?(s.editAddress.Area=t.Data,s.submitAddress()):s.selectArea(e)}).error(function(t){s.selectArea(e)})}},s.submitAddress=function(){t.post("/customer/addAddress",s.editAddress).success(function(e){e.Succeeded?(s.loadDeliveryAddress(),s.gotoUrl("/customer/checkout")):alert(e.Message)}).error(function(e){alert(e)})}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("CustomerController",["$window","$scope","$http","CommonService",function(e,t,o,n){var r=this;r.init=function(){r.cart=new Greenspot.Cart,r.cart.load()},r.initStall=function(e){return n.showLoading(),r.restoreStall(e)?(document.title=r.currentStall.Name,void n.hideLoading()):void o.get("/api/stall/"+e).success(function(e){e.Succeeded?(r.currentStall=e.Data,r.currentStall[0]=e.Data.InitialProducts,r.currentStall.selectedCateIdx=0,r.currentStall.selectedCategoryProducts=e.Data.InitialProducts,document.title=r.currentStall.Name,r.storeStall(r.currentStall)):console.log(e.Message)}).error(function(e){console.log(e)}).finally(function(){n.hideLoading(),r.currentStall||(r.currentStall=null)})},r.changeCategory=function(e,t){n.showLoading();var s=r.currentStall[t];s&&s.length>0&&(r.currentStall.selectedCateIdx=t,r.currentStall.selectedCategoryProducts=s,r.storeStall(r.currentStall),n.hideLoading()),o.get("/api/stall/"+e+"/category/"+t).success(function(e){e.Succeeded?(r.currentStall[t]=e.Data,r.currentStall.selectedCateIdx=t,r.currentStall.selectedCategoryProducts=r.currentStall[t],r.storeStall(r.currentStall)):console.log(e.Message)}).error(function(e){console.log(e)}).finally(function(){n.hideLoading()})},r.storeStall=function(t){e.localStorage&&t&&e.localStorage.setItem("pre_stall",JSON.stringify(t))},r.restoreStall=function(t){if(!e.localStorage||!e.localStorage.pre_stall)return!1;var o=JSON.parse(e.localStorage.pre_stall);return o.Id==t&&(r.currentStall=o,!0)},r.init_productHome=function(e){r.init(),r.loadProduct(e)},r.loadProduct=function(e){n.showLoading(),o.get("/api/product/"+e).success(function(e){e.Succeeded?(r.currentProduct=e.Data,document.title=r.currentProduct.Name):console.log(e.Message)}).error(function(e){console.log(e)}).finally(function(){n.hideLoading(),r.currentProduct||(r.currentProduct=null)})},r.checkOut=function(){r.cart.save(),window.location.href="/customer/Checkout"},r.init_checkout=function(){r.init(),r.loadDeliveryAddress(),r.orders=[];var e=r.cart.getOrders();angular.forEach(e.orders,function(e,t){r.orders.push(new Greenspot.Order(e,o))})},r.loadDeliveryAddress=function(){o.get("/customer/DeliveryAddresses").success(function(e){e.Succeeded?(r.deliveryAddresses=e.Data,r.deliveryAddresses.length>0&&(r.selectedDeliveryAddress=r.deliveryAddresses[0],r.deliveryAddressChanged())):console.log(e.Message)}).error(function(e){console.log(e)})},r.deliveryAddressChanged=function(){angular.forEach(r.orders,function(e,t){e.setDeliveryAddress(r.selectedDeliveryAddress)})},r.allDeliverySelected=function(){for(var e=r.orders.length,t=0;t<e;t++)if(!r.orders[t].selectedOption)return!1;return!0},r.pay=function(){n.showLoading(),r.error={};var e=angular.copy(r.orders);angular.forEach(e,function(e,t){delete e.deliveryOptionCollections,delete e.pickUpOptionCollections,delete e.optionCollections,delete e.selectedOptionCollection}),o.post("/customer/Pay",r.orders).success(function(e){e.Succeeded?(delete r.error,window.location.href=e.Data):"OutOfStock"===e.ErrorType?(r.error.outOfStock=!0,r.error.outOfStockData=$.parseJSON(e.Data)):(r.error.other=!0,r.error.message=e.Data)}).error(function(e){r.error.other=!0,r.error.message=e})},r.init_orders=function(e){r.init(),console.log("ispaid:",e),e&&r.cart.removeSelected()}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("DialogController",["$scope","$mdDialog",function(e,t){e.hide=function(){t.hide()},e.cancel=function(){t.cancel()},e.answer=function(e){t.hide(e)}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("HomeController",["$window","$scope","$location","$http","CommonService",function(e,t,o,n,r){var s=this;s.isLoading=function(){return r.isLoading()},s.searchCondition={isRecommend:!0,category:"T",area:"nz:auckland",keyword:"",init:function(){var e=o.search();this.category="T","H"===e.c&&(this.category="H"),this.isRecommend="false"!=e.r,this.area=e.a||this.area,this.keyword=e.k||this.keyword},queryString:function(){return"?c="+this.category+"&r="+this.isRecommend+"&a="+this.area+"&k="+this.keyword},queryObject:function(){return{r:this.isRecommend,c:this.category,a:this.area,k:this.keyword}}},s.init_cart=function(){s.cart=new Greenspot.Cart,s.cart.load()},s.init=function(){s.searchCondition.init(),s.searchCondition.isRecommend?s.loadRecommendStalls():s.restoreSearchResult()||s.search(),s.init_cart()},s.loadRecommendStalls=function(){r.showLoading(),s.recommendStalls=new Greenspot.Utilities.SearchResult(0,20);var e="/api/stall/recommend?c="+s.searchCondition.category+"&a="+s.searchCondition.area;n.get(e).success(function(e){e.Succeeded?s.recommendStalls.append(e.Data):console.log(e.Message)}).error(function(e){console.log(e)}).finally(function(){r.hideLoading()})},s.searchProduct=function(t,o){t=t||0,o=o||10,0==t?s.matchedProducts=new Greenspot.Utilities.SearchResult(t,o):(s.matchedProducts.page=t,s.matchedProducts.pageSize=o),n.get("/api/product/search"+s.searchCondition.queryString()+"&p="+t+"&ps="+o).success(function(t){t.Succeeded?(s.matchedProducts.append(t.Data),e.localStorage&&s.matchedProducts&&e.localStorage.setItem("matched_products",JSON.stringify(s.matchedProducts))):console.log(t.Message)}).error(function(e){console.log(e)}).finally(function(){r.hideLoading()})},s.loadMoreProduct=function(){r.showLoading(),s.searchProduct(s.matchedProducts.page+1,s.matchedProducts.pageSize)},s.searchStall=function(t,o){t=t||0,o=o||10,0==t?s.matchedStalls=new Greenspot.Utilities.SearchResult(t,o):(s.matchedStalls.page=t,s.matchedStalls.pageSize=o),n.get("/api/stall/search"+s.searchCondition.queryString()+"&p="+t+"&ps="+o).success(function(t){t.Succeeded?(s.matchedStalls.append(t.Data),e.localStorage&&s.matchedStalls&&e.localStorage.setItem("matched_stalls",JSON.stringify(s.matchedStalls))):console.log(t.Message)}).error(function(e){console.log(e)}).finally(function(){r.hideLoading()})},s.loadMoreStall=function(){r.showLoading(),s.searchStall(s.matchedStalls.page+1,s.matchedStalls.pageSize)},s.search=function(t,n){r.showLoading(),s.searchCondition.isRecommend=!1,s.recommendStalls=null,e.localStorage&&e.localStorage.setItem("pre_condition",JSON.stringify(s.searchCondition)),s.searchProduct(0,n),s.searchStall(0,t),o.search(s.searchCondition.queryObject())},s.gotoStall=function(o){e.localStorage.removeItem("pre_stall"),t.gotoUrl("/stall/"+o)},s.restoreSearchResult=function(){if(e.localStorage&&e.localStorage.pre_condition){var t=JSON.parse(e.localStorage.pre_condition);if(t.category!=s.searchCondition.category||t.area!=s.searchCondition.area||t.keyword!=s.searchCondition.keyword)return!1;e.localStorage.matched_stalls&&(s.matchedStalls=Greenspot.Utilities.SearchResult.Parse(e.localStorage.matched_stalls)),e.localStorage.matched_products&&(s.matchedProducts=Greenspot.Utilities.SearchResult.Parse(e.localStorage.matched_products))}return s.matchedStalls||!1||s.matchedProducts||!1}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.controller("OwnerController",["$http","$location","CommonService",function(e,t,o){var n=this;n.Apply=function(){o.showLoading(),e.post("/owner/apply",this.OwnerInfo).success(function(e){e.Succeeded?window.location.reload():console.log(e.Message)}).error(function(e){console.log(e)}).finally(function(){o.hideLoading()})}}])}(),function(){"use strict";var e=angular.module("greenspotStall");e.directive("googleplace",function(){return{scope:{addrObj:"=addressObject",placeOnSelect:"&"},link:function(e,t,o,n){var r={types:["address"],componentRestrictions:{country:"nz"}};e.googlePlaceAutocomplete=new google.maps.places.Autocomplete(t[0],r),google.maps.event.addListener(e.googlePlaceAutocomplete,"place_changed",function(){e.$apply(function(){e.addrObj=e.googlePlaceAutocomplete.getPlace()}),e.placeOnSelect()})}}})}(),function(){"use strict";var e=angular.module("greenspotStall");e.directive("addressChecker",function(){return{scope:{addrObj:"=addressObject",placeOnSelect:"&"},link:function(e,t,o,n){var r={max_results:3,search_type:"Physical",populates:{suburb:"Suburb",city:"CityTown",postcode:"Postcode"},theme:{boxClass:"AddrAutoCompleteBox"},success:function(t){e.$apply(function(){e.addrObj=t}),e.placeOnSelect()}};e.addressChecker=new NZPost.Addressing.Checker(t[0],"af322550-a9de-0132-86ce-00505692031f",r)}}})}();